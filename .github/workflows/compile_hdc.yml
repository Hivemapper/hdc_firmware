name: compile_hdc

on:
  workflow_dispatch:
  push:
    tags:
      - "*"

jobs:
  build:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.CLASSIC_TOKEN }}
          submodules: recursive
      # - uses: bettermarks/action-artifact-download@0.3.0
      #   with:
      #       token: ${{ secrets.CLASSIC_TOKEN }}
      #       repo: hivemapper/odc-api
      #       artifact_name: odc-api
      #       wait_seconds: 30
      # - run: |
      #     unzip odc-api
      #     mv dashcam-api.js  dashcam/package/camera-node/files/
      - name: configure
        run: |
          make -s -C buildroot/ BR2_EXTERNAL=../dashcam O=../../output raspberrypicm4io_64_dev_dashcam_defconfig
      - name: Compile
        run: |
          cd ../output
          make clean
      - name: Compile
        run: |
          cd ../output
          make
      - name: Copy target
        run: |
          mkdir output
          cp ../output/images/update.raucb ./output/firmware_update.raucb
      - name: Upload
        uses: actions/upload-artifact@master
        with:
          name: buildroot-hdc
          path: output/firmware_update.raucb
